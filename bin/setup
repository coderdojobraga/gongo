#!/usr/bin/env bash

set -Eeuo pipefail

BASE_DIR=$(dirname "${BASH_SOURCE[0]:-$0}")
cd "${BASE_DIR}/.." || exit 127

# shellcheck source=../scripts/logging.sh
. scripts/logging.sh
# shellcheck source=../scripts/utils.sh
. scripts/utils.sh

if not_installed "asdf"; then
  echo_warning "
    We are using asdf (https://github.com/asdf-vm/asdf) to manage tool
    dependencies, since it was not found on your system we cannot ensure that you
    are using the correct versions of all the tools. Please install it and run
    this script again, or proceed at your own peril.
  "
else
  set +e
  asdf plugin add python
  set -e

  asdf install python $(read <.python-version)
fi

log_info "setup" "Setting up the env file..."
if [ ! -f .env ]; then
  cp .env.sample .env
  log_done "env file created, you might want to open .env and set the correct values..."
  echo
else
  log_warn ".env file already exists, skipping..."
  echo
fi

log_info "setup" "Creating virtual environment..."
python3 -m venv .venv

log_info "setup" "Activating virtual environment..."
source .venv/bin/activate

log_info "setup" "Installing project dependencies..."
python3 -m pip install -r requirements.txt

log_info "setup" "Installing dev dependencies..."
python3 -m pip install -r requirements-dev.txt

log_info "setup" "Register pre-commit as git hook..."
python3 -m pre_commit install
